<app-modal
  [open]="open()"
  (closeModal)="onClose()"
  i18n-title="@@editTaskModal.title"
  title="Rediger oppgave"
>
  @if (!showDeleteConfirm()) {
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <div class="form-group">
        <label class="form-label" for="edit-task-name" i18n="@@editTaskModal.taskNameLabel"
          >Oppgavenavn *</label
        >
        <input
          type="text"
          id="edit-task-name"
          class="form-input"
          formControlName="name"
          i18n-placeholder="@@editTaskModal.taskNamePlaceholder"
          placeholder="f.eks. Ta ut søpla"
          [class.error]="form.controls.name.invalid && form.controls.name.touched"
          [attr.aria-invalid]="form.controls.name.invalid && form.controls.name.touched"
          [attr.aria-describedby]="
            form.controls.name.invalid && form.controls.name.touched ? 'edit-task-name-error' : null
          "
        />
        @if (form.controls.name.invalid && form.controls.name.touched) {
          <div id="edit-task-name-error" class="form-error" role="alert">
            @if (form.controls.name.errors?.['required']) {
              <span i18n="@@editTaskModal.taskNameRequired">Oppgavenavn er obligatorisk</span>
            }
            @if (form.controls.name.errors?.['maxlength']) {
              <span i18n="@@editTaskModal.taskNameTooLong"
                >Oppgavenavnet er for langt (maks 255 tegn)</span
              >
            }
          </div>
        }
      </div>

      <div class="form-group">
        <label class="form-label" for="edit-points" i18n="@@editTaskModal.pointsLabel">Poeng</label>
        <input
          type="number"
          id="edit-points"
          class="form-input"
          formControlName="points"
          min="1"
          max="1000"
          [class.error]="form.controls.points.invalid && form.controls.points.touched"
          [attr.aria-invalid]="form.controls.points.invalid && form.controls.points.touched"
          [attr.aria-describedby]="
            form.controls.points.invalid && form.controls.points.touched
              ? 'edit-points-error'
              : null
          "
        />
        @if (form.controls.points.invalid && form.controls.points.touched) {
          <div id="edit-points-error" class="form-error" role="alert">
            @if (form.controls.points.errors?.['min']) {
              <span i18n="@@editTaskModal.pointsMin">Poeng må være minst 1</span>
            }
            @if (form.controls.points.errors?.['max']) {
              <span i18n="@@editTaskModal.pointsMax">Poeng må være maks 1000</span>
            }
          </div>
        }
      </div>

      <div class="form-group">
        <label class="form-label" for="edit-recurrence" i18n="@@editTaskModal.recurrenceLabel"
          >Gjentakelse *</label
        >
        <select
          id="edit-recurrence"
          class="form-select"
          formControlName="ruleType"
          [class.error]="form.controls.ruleType.invalid && form.controls.ruleType.touched"
        >
          @for (option of recurrenceOptions; track option.value) {
            <option [value]="option.value">{{ option.label }}</option>
          }
        </select>
      </div>

      <!-- Repeat Days (shown if repeating) -->
      @if (ruleType === 'repeating') {
        <div class="form-group">
          <fieldset class="day-fieldset">
            <legend class="form-label" i18n="@@editTaskModal.repeatOnLabel">Gjenta på *</legend>
            <div
              class="day-selector"
              role="group"
              i18n-aria-label="@@editTaskModal.selectDaysAriaLabel"
              aria-label="Velg dager"
            >
              @for (day of daysOfWeek; track day.value) {
                <label class="day-checkbox">
                  <input
                    type="checkbox"
                    [checked]="isDaySelected(day.value)"
                    (change)="onDayChange(day.value, $any($event.target).checked)"
                    [attr.aria-label]="'Gjenta på ' + day.label"
                  />
                  {{ day.label }}
                </label>
              }
            </div>
            @if (form.controls.repeatDays.invalid && form.controls.repeatDays.touched) {
              <div class="form-error" role="alert" i18n="@@editTaskModal.selectAtLeastOneDay">
                Velg minst én dag
              </div>
            }
          </fieldset>
        </div>
      }

      <!-- Rotation Type (shown if weekly_rotation) -->
      @if (ruleType === 'weekly_rotation') {
        <div class="form-group">
          <label
            class="form-label"
            for="edit-rotation-type"
            i18n="@@editTaskModal.rotationTypeLabel"
            >Rotasjonstype *</label
          >
          <select
            id="edit-rotation-type"
            class="form-select"
            formControlName="rotationType"
            [class.error]="form.controls.rotationType.invalid && form.controls.rotationType.touched"
          >
            @for (option of rotationOptions; track option.value) {
              <option [value]="option.value">{{ option.label }}</option>
            }
          </select>
        </div>
      }

      <!-- Assigned Children (shown for all rule types except single) -->
      @if (ruleType !== 'single') {
        <div class="form-group">
          <fieldset class="child-fieldset">
            <legend class="form-label">
              <span i18n="@@editTaskModal.assignToChildrenLabel">Tildel til barn</span>
              @if (ruleType !== 'daily') {
                <span class="required">*</span>
              }
              @if (ruleType === 'weekly_rotation') {
                <span class="help-text" i18n="@@editTaskModal.selectTwoForRotation"
                  >(Velg 2+ for rotasjon)</span
                >
              } @else if (ruleType === 'daily') {
                <span class="help-text" i18n="@@editTaskModal.optional">(Valgfritt)</span>
              }
            </legend>
            <div
              class="children-selector"
              role="group"
              i18n-aria-label="@@editTaskModal.assignChildrenAriaLabel"
              aria-label="Tildel barn"
            >
              @for (child of children(); track child.id) {
                <label class="child-checkbox">
                  <input
                    type="checkbox"
                    [checked]="isChildSelected(child.id)"
                    (change)="onChildChange(child.id, $any($event.target).checked)"
                    [attr.aria-label]="'Tildel til ' + child.name"
                  />
                  {{ child.name }}
                </label>
              }
              @if (children().length === 0) {
                <p class="no-children-message" i18n="@@editTaskModal.noChildrenYet">
                  Ingen barn i denne husholdningen ennå.
                </p>
              }
            </div>
            @if (form.controls.assignedChildren.invalid && form.controls.assignedChildren.touched) {
              <div class="form-error" role="alert">
                @if (ruleType === 'weekly_rotation') {
                  <span i18n="@@editTaskModal.selectAtLeastTwoChildren"
                    >Velg minst 2 barn for rotasjon</span
                  >
                } @else {
                  <span i18n="@@editTaskModal.selectAtLeastOneChild">Velg minst 1 barn</span>
                }
              </div>
            }
          </fieldset>
        </div>
      }

      <!-- Single task info message -->
      @if (ruleType === 'single') {
        <div class="form-group">
          <div class="info-message" i18n="@@editTaskModal.singleTaskInfo">
            Enkeltoppgaver er tilgjengelige for ethvert barn å ta. De vises i seksjonen
            "Tilgjengelige oppgaver".
          </div>
        </div>
      }

      <div class="modal-actions-split" modal-actions>
        <button
          type="button"
          class="btn btn-danger"
          (click)="onDeleteClick()"
          i18n="@@editTaskModal.deleteButton"
        >
          Slett
        </button>
        <div class="modal-actions-right">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="onCancel()"
            i18n="@@editTaskModal.cancelButton"
          >
            Avbryt
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="form.invalid || submitting()"
            i18n="@@editTaskModal.saveButton"
          >
            Lagre endringer
          </button>
        </div>
      </div>
    </form>
  } @else {
    <div class="delete-confirm">
      <p class="delete-confirm-text" i18n="@@editTaskModal.deleteConfirmText">
        Er du sikker på at du vil slette denne oppgaven? Denne handlingen kan ikke angres.
      </p>

      <div class="modal-actions" modal-actions>
        <button
          type="button"
          class="btn btn-secondary"
          (click)="onCancelDelete()"
          i18n="@@editTaskModal.cancelDeleteButton"
        >
          Avbryt
        </button>
        <button
          type="button"
          class="btn btn-danger"
          (click)="onConfirmDelete()"
          i18n="@@editTaskModal.confirmDeleteButton"
        >
          Ja, slett oppgave
        </button>
      </div>
    </div>
  }
</app-modal>
