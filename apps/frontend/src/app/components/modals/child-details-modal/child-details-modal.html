<app-modal
  [open]="open()"
  (closeModal)="onClose()"
  i18n-title="@@childDetailsModal.title"
  title="Barnedetaljer"
>
  @if (child(); as child) {
    <div class="child-details">
      <!-- Error Message -->
      @if (errorMessage()) {
        <div class="error-banner" role="alert">
          {{ errorMessage() }}
        </div>
      }

      <!-- Delete Confirmation -->
      @if (showDeleteConfirm()) {
        <div class="delete-confirmation">
          <div class="confirm-icon">‚ö†Ô∏è</div>
          <h3 class="confirm-title" i18n="@@childDetailsModal.removeConfirmTitle">
            Fjerne {{ child.name }}?
          </h3>
          <p class="confirm-message" i18n="@@childDetailsModal.removeConfirmMessage">
            Er du sikker p√• at du vil fjerne {{ child.name }} fra denne husholdningen? Denne
            handlingen kan ikke angres.
          </p>
          <div class="confirm-actions">
            <button
              type="button"
              class="btn btn-secondary"
              (click)="cancelDelete()"
              [disabled]="deleting()"
              i18n="@@childDetailsModal.cancelButton"
            >
              Avbryt
            </button>
            <button
              type="button"
              class="btn btn-danger"
              (click)="confirmDelete()"
              [disabled]="deleting()"
            >
              @if (deleting()) {
                <span i18n="@@childDetailsModal.removingButton">Fjerner...</span>
              } @else {
                <span i18n="@@childDetailsModal.removeChildButton">Fjern barn</span>
              }
            </button>
          </div>
        </div>
      } @else {
        <!-- Child Info Section -->
        <div class="info-section">
          <div class="child-avatar">
            <span class="avatar-emoji">
              @if (child.avatarUrl) {
                {{ child.avatarUrl }}
              } @else {
                üë§
              }
            </span>
          </div>

          @if (editMode()) {
            <!-- Edit Mode -->
            <form class="edit-form" [formGroup]="form" (ngSubmit)="saveEdit()">
              <div class="form-group">
                <label class="form-label" for="child-name" i18n="@@childDetailsModal.nameLabel"
                  >Navn</label
                >
                <input
                  type="text"
                  id="child-name"
                  class="form-input"
                  formControlName="name"
                  [class.error]="form.controls.name.invalid && form.controls.name.touched"
                />
                @if (form.controls.name.invalid && form.controls.name.touched) {
                  <div class="form-error" i18n="@@childDetailsModal.nameRequired">
                    Navn er obligatorisk
                  </div>
                }
              </div>

              <div class="form-group">
                <label class="form-label" for="birth-year" i18n="@@childDetailsModal.birthYearLabel"
                  >F√∏dsels√•r</label
                >
                <input
                  type="number"
                  id="birth-year"
                  class="form-input birth-year-input"
                  formControlName="birthYear"
                  [min]="minBirthYear"
                  [max]="currentYear"
                  [class.error]="form.controls.birthYear.invalid && form.controls.birthYear.touched"
                />
                @if (form.controls.birthYear.invalid && form.controls.birthYear.touched) {
                  <div class="form-error" i18n="@@childDetailsModal.birthYearInvalid">
                    Vennligst oppgi et gyldig f√∏dsels√•r
                  </div>
                }
              </div>

              <div class="edit-actions">
                <button
                  type="button"
                  class="btn btn-secondary btn-sm"
                  (click)="cancelEdit()"
                  [disabled]="saving()"
                  i18n="@@childDetailsModal.cancelEditButton"
                >
                  Avbryt
                </button>
                <button
                  type="submit"
                  class="btn btn-primary btn-sm"
                  [disabled]="form.invalid || saving()"
                >
                  @if (saving()) {
                    <span i18n="@@childDetailsModal.savingButton">Lagrer...</span>
                  } @else {
                    <span i18n="@@childDetailsModal.saveButton">Lagre</span>
                  }
                </button>
              </div>
            </form>
          } @else {
            <!-- View Mode -->
            <div class="child-info">
              <h3 class="child-name">{{ child.name }}</h3>
              @if (childAge()) {
                <p class="child-age" i18n="@@childDetailsModal.yearsOld">
                  {{ childAge() }} √•r gammel
                </p>
              }
              <button
                type="button"
                class="btn-edit"
                (click)="enterEditMode()"
                i18n-aria-label="@@childDetailsModal.editAriaLabel"
                aria-label="Rediger barnedetaljer"
              >
                <span i18n="@@childDetailsModal.editButton">‚úèÔ∏è Rediger</span>
              </button>
            </div>
          }
        </div>

        <!-- Account Status Section -->
        @if (!editMode()) {
          <div class="account-section">
            <h4 class="section-title" i18n="@@childDetailsModal.loginAccountTitle">
              Innloggingskonto
            </h4>

            @if (hasAccount()) {
              <!-- Child has account -->
              <div class="account-status has-account">
                <span class="status-icon">‚úì</span>
                <div class="status-info">
                  <p class="status-label" i18n="@@childDetailsModal.accountActive">Konto aktiv</p>
                  @if (childEmail()) {
                    <p class="status-detail">{{ childEmail() }}</p>
                  }
                </div>
              </div>
            } @else {
              <!-- Child does not have account -->
              @if (!showCreateAccount()) {
                <div class="account-status no-account">
                  <span class="status-icon">‚úó</span>
                  <div class="status-info">
                    <p class="status-label" i18n="@@childDetailsModal.noAccount">Ingen konto</p>
                    <p class="status-detail" i18n="@@childDetailsModal.noAccountDescription">
                      Opprett innloggingsdetaljer slik at barnet kan logge inn
                    </p>
                  </div>
                </div>

                <button
                  type="button"
                  class="btn btn-primary create-btn"
                  (click)="toggleCreateAccount()"
                  i18n="@@childDetailsModal.createLoginButton"
                >
                  Opprett innlogging
                </button>
              } @else {
                <!-- Create Account Form -->
                <app-create-child-account
                  [child]="child"
                  [householdId]="householdId()"
                  (accountCreated)="onAccountCreated()"
                  (cancelled)="onCreateAccountCancelled()"
                />
              }
            }
          </div>

          <!-- QR Code Section (Future Feature) -->
          <div class="qr-section">
            <h4 class="section-title" i18n="@@childDetailsModal.qrCodeTitle">QR-kode innlogging</h4>
            <div class="qr-placeholder">
              <div class="qr-icon">üì±</div>
              <p class="qr-label" i18n="@@childDetailsModal.comingSoon">Kommer snart</p>
              <p class="qr-description" i18n="@@childDetailsModal.qrDescription">
                Rask innlogging med QR-kode skanning
              </p>
            </div>
          </div>

          <!-- Danger Zone -->
          <div class="danger-zone">
            <h4 class="section-title danger-title" i18n="@@childDetailsModal.dangerZoneTitle">
              Faresone
            </h4>
            <p class="danger-description" i18n="@@childDetailsModal.dangerZoneDescription">
              Fjerning av et barn vil slette alle oppgavetildelinger og poenghistorikk.
            </p>
            <button
              type="button"
              class="btn btn-danger-outline"
              (click)="showDeleteConfirmation()"
              i18n="@@childDetailsModal.removeChildAction"
            >
              Fjern barn
            </button>
          </div>
        }
      }
    </div>
  }

  <!-- Modal Actions -->
  @if (!showCreateAccount() && !editMode() && !showDeleteConfirm()) {
    <div class="modal-actions" modal-actions>
      <button
        type="button"
        class="btn btn-secondary"
        (click)="onClose()"
        i18n="@@childDetailsModal.closeButton"
      >
        Lukk
      </button>
    </div>
  }
</app-modal>
