<div class="children-management">
  <div class="header">
    <h2 i18n="@@childrenManagement.title">Barneadministrasjon</h2>
    <button
      type="button"
      class="btn btn-primary"
      (click)="toggleAddForm()"
      [disabled]="isLoading()"
      i18n-aria-label="@@childrenManagement.addChildAriaLabel"
      aria-label="Legg til barn"
    >
      @if (isAdding()) {
        <span i18n="@@childrenManagement.cancel">Avbryt</span>
      } @else {
        <span i18n="@@childrenManagement.addChild">+ Legg til barn</span>
      }
    </button>
  </div>

  <!-- Success message -->
  @if (successMessage()) {
    <div class="alert alert-success" role="alert">
      {{ successMessage() }}
    </div>
  }

  <!-- Error message -->
  @if (errorMessage()) {
    <div class="alert alert-error" role="alert">
      {{ errorMessage() }}
    </div>
  }

  <!-- Add child form -->
  @if (isAdding()) {
    <form [formGroup]="addForm" (ngSubmit)="addChild()" class="child-form">
      <h3 i18n="@@childrenManagement.addNewChild">Legg til nytt barn</h3>

      <div class="form-group">
        <label for="add-name" i18n="@@childrenManagement.nameLabel">Navn *</label>
        <input
          id="add-name"
          type="text"
          formControlName="name"
          i18n-placeholder="@@childrenManagement.namePlaceholder"
          placeholder="Barnets navn"
          [class.invalid]="addForm.get('name')?.invalid && addForm.get('name')?.touched"
          aria-required="true"
        />
        @if (addForm.get('name')?.invalid && addForm.get('name')?.touched) {
          <span class="error-text" role="alert">
            @if (addForm.get('name')?.errors?.['required']) {
              <span i18n="@@childrenManagement.nameRequired">Navn er påkrevd</span>
            }
            @if (addForm.get('name')?.errors?.['minlength']) {
              <span i18n="@@childrenManagement.nameMinLength">Navn må være minst 2 tegn</span>
            }
            @if (addForm.get('name')?.errors?.['maxlength']) {
              <span i18n="@@childrenManagement.nameMaxLength"
                >Navn må være 100 tegn eller mindre</span
              >
            }
          </span>
        }
      </div>

      <div class="form-group">
        <label for="add-birth-year" i18n="@@childrenManagement.birthYearLabel">Fødselsår *</label>
        <input
          id="add-birth-year"
          type="number"
          formControlName="birthYear"
          [min]="2000"
          [max]="currentYear"
          [class.invalid]="addForm.get('birthYear')?.invalid && addForm.get('birthYear')?.touched"
          aria-required="true"
        />
        @if (addForm.get('birthYear')?.invalid && addForm.get('birthYear')?.touched) {
          <span class="error-text" role="alert">
            @if (addForm.get('birthYear')?.errors?.['required']) {
              <span i18n="@@childrenManagement.birthYearRequired">Fødselsår er påkrevd</span>
            }
            @if (
              addForm.get('birthYear')?.errors?.['min'] || addForm.get('birthYear')?.errors?.['max']
            ) {
              <span i18n="@@childrenManagement.birthYearRange"
                >Fødselsår må være mellom 2000 og {{ currentYear }}</span
              >
            }
          </span>
        }
      </div>

      <div class="form-actions">
        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="isLoading() || addForm.invalid"
          i18n-aria-label="@@childrenManagement.addChildToHouseholdAriaLabel"
          aria-label="Legg til barn i husstanden"
        >
          @if (isLoading()) {
            <span i18n="@@childrenManagement.adding">Legger til...</span>
          } @else {
            <span i18n="@@childrenManagement.addChildButton">Legg til barn</span>
          }
        </button>
        <button
          type="button"
          class="btn btn-secondary"
          (click)="toggleAddForm()"
          [disabled]="isLoading()"
          i18n-aria-label="@@childrenManagement.cancelAddingAriaLabel"
          aria-label="Avbryt å legge til barn"
          i18n="@@childrenManagement.cancelButton"
        >
          Avbryt
        </button>
      </div>
    </form>
  }

  <!-- Loading state -->
  @if (isLoading() && !isAdding()) {
    <div class="loading" i18n="@@childrenManagement.loading">Laster barn...</div>
  }

  <!-- Empty state -->
  @if (!isLoading() && children().length === 0) {
    <div class="empty-state">
      <p i18n="@@childrenManagement.noChildrenYet">Ingen barn lagt til ennå.</p>
      <p i18n="@@childrenManagement.clickToAdd">Klikk "Legg til barn" for å komme i gang.</p>
    </div>
  }

  <!-- Children list -->
  @if (!isLoading() && children().length > 0) {
    <div class="children-list">
      @for (child of children(); track child.id) {
        <div class="child-card">
          @if (editingId() === child.id) {
            <!-- Edit mode -->
            <form [formGroup]="editForm" (ngSubmit)="saveEdit(child.id)" class="edit-form">
              <div class="form-group">
                <label [attr.for]="'edit-name-' + child.id" i18n="@@childrenManagement.nameLabel"
                  >Navn *</label
                >
                <input
                  [id]="'edit-name-' + child.id"
                  type="text"
                  formControlName="name"
                  [class.invalid]="editForm.get('name')?.invalid && editForm.get('name')?.touched"
                  aria-required="true"
                />
                @if (editForm.get('name')?.invalid && editForm.get('name')?.touched) {
                  <span class="error-text" role="alert">
                    @if (editForm.get('name')?.errors?.['required']) {
                      <span i18n="@@childrenManagement.nameRequired">Navn er påkrevd</span>
                    }
                    @if (editForm.get('name')?.errors?.['minlength']) {
                      <span i18n="@@childrenManagement.nameMinLength"
                        >Navn må være minst 2 tegn</span
                      >
                    }
                  </span>
                }
              </div>

              <div class="form-group">
                <label
                  [attr.for]="'edit-birth-year-' + child.id"
                  i18n="@@childrenManagement.birthYearLabel"
                  >Fødselsår *</label
                >
                <input
                  [id]="'edit-birth-year-' + child.id"
                  type="number"
                  formControlName="birthYear"
                  [min]="2000"
                  [max]="currentYear"
                  [class.invalid]="
                    editForm.get('birthYear')?.invalid && editForm.get('birthYear')?.touched
                  "
                  aria-required="true"
                />
                @if (editForm.get('birthYear')?.invalid && editForm.get('birthYear')?.touched) {
                  <span class="error-text" role="alert" i18n="@@childrenManagement.birthYearRange">
                    Fødselsår må være mellom 2000 og {{ currentYear }}
                  </span>
                }
              </div>

              <div class="form-actions">
                <button
                  type="submit"
                  class="btn btn-sm btn-primary"
                  [disabled]="isLoading()"
                  i18n="@@childrenManagement.save"
                >
                  Lagre
                </button>
                <button
                  type="button"
                  class="btn btn-sm btn-secondary"
                  (click)="cancelEdit()"
                  [disabled]="isLoading()"
                  i18n="@@childrenManagement.cancelButton"
                >
                  Avbryt
                </button>
              </div>
            </form>
          } @else {
            <!-- Display mode -->
            <div class="child-info">
              <div class="child-details">
                <h3>{{ child.name }}</h3>
                <p class="child-age">
                  <ng-container i18n="@@childrenManagement.age"
                    >Alder: {{ getAge(child.birthYear ?? null) }} (Født
                    {{ child.birthYear }})</ng-container
                  >
                </p>
              </div>
              <div class="child-actions">
                <button
                  type="button"
                  class="btn btn-sm btn-secondary"
                  (click)="startEdit(child)"
                  [disabled]="isLoading()"
                  [attr.aria-label]="'Edit ' + child.name"
                  i18n="@@childrenManagement.edit"
                >
                  Rediger
                </button>
                <button
                  type="button"
                  class="btn btn-sm btn-danger"
                  (click)="deleteChild(child)"
                  [disabled]="isLoading()"
                  [attr.aria-label]="'Delete ' + child.name"
                  i18n="@@childrenManagement.delete"
                >
                  Slett
                </button>
              </div>
            </div>
          }
        </div>
      }
    </div>
  }
</div>
