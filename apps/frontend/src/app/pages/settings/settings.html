<!-- Loading State -->
@if (loading()) {
  <div class="loading-container" role="status" aria-live="polite">
    <div class="spinner" aria-hidden="true"></div>
    <p i18n="@@settings.loading">Laster profilen din...</p>
  </div>
}

<!-- Error State (full page) -->
@if (error() && !loading() && !profile()) {
  <div class="error-container" role="alert" aria-live="assertive">
    <div class="error-icon" aria-hidden="true">!</div>
    <h2 i18n="@@settings.errorTitle">Oops!</h2>
    <p>{{ error() }}</p>
    <button class="btn-retry" (click)="loadProfile()" i18n="@@settings.tryAgain">Pr√∏v igjen</button>
  </div>
}

<!-- Main Content -->
@if (!loading() && profile()) {
  <app-page i18n-title="@@settings.pageTitle" title="Innstillinger" maxWidth="narrow">
    <!-- Success Message -->
    @if (successMessage()) {
      <div class="alert alert-success" role="status" aria-live="polite">
        <span>{{ successMessage() }}</span>
        <button
          class="alert-dismiss"
          (click)="dismissSuccess()"
          i18n-aria-label="@@settings.dismissAriaLabel"
          aria-label="Lukk"
        >
          x
        </button>
      </div>
    }

    <!-- Error Message (inline) -->
    @if (error() && profile()) {
      <div class="alert alert-error" role="alert" aria-live="assertive">
        <span>{{ error() }}</span>
        <button
          class="alert-dismiss"
          (click)="dismissError()"
          i18n-aria-label="@@settings.dismissAriaLabel"
          aria-label="Lukk"
        >
          x
        </button>
      </div>
    }

    <!-- Profile Section -->
    <section class="settings-section">
      <h2 i18n="@@settings.profileTitle">Profil</h2>

      <form class="settings-form" (submit)="saveProfile(); $event.preventDefault()">
        <!-- First Name Field -->
        <div class="form-group">
          <label for="firstName" i18n="@@settings.firstNameLabel">Fornavn</label>
          <input
            type="text"
            id="firstName"
            name="firstName"
            [(ngModel)]="firstName"
            i18n-placeholder="@@settings.firstNamePlaceholder"
            placeholder="Skriv inn fornavnet ditt"
            maxlength="100"
          />
        </div>

        <!-- Last Name Field -->
        <div class="form-group">
          <label for="lastName" i18n="@@settings.lastNameLabel">Etternavn</label>
          <input
            type="text"
            id="lastName"
            name="lastName"
            [(ngModel)]="lastName"
            i18n-placeholder="@@settings.lastNamePlaceholder"
            placeholder="Skriv inn etternavnet ditt"
            maxlength="100"
          />
          <small class="form-hint" i18n="@@settings.lastNameHint"
            >Slik vil du vises for andre familiemedlemmer</small
          >
        </div>

        <!-- Email Field -->
        <div class="form-group">
          <label for="email" i18n="@@settings.emailLabel">E-postadresse</label>
          <input
            type="email"
            id="email"
            name="email"
            [(ngModel)]="email"
            i18n-placeholder="@@settings.emailPlaceholder"
            placeholder="Skriv inn e-posten din"
            required
          />
        </div>

        <!-- Password Section Toggle -->
        <button type="button" class="btn-link" (click)="togglePasswordSection()">
          @if (showPasswordSection()) {
            <span i18n="@@settings.hidePasswordSection">- Skjul passordseksjon</span>
          } @else {
            <span i18n="@@settings.changePassword">+ Endre passord</span>
          }
        </button>

        <!-- Password Fields (conditionally shown) -->
        @if (showPasswordSection()) {
          <div class="password-section">
            <div class="form-group">
              <label for="newPassword" i18n="@@settings.newPasswordLabel">Nytt passord</label>
              <input
                type="password"
                id="newPassword"
                name="newPassword"
                [(ngModel)]="newPassword"
                i18n-placeholder="@@settings.newPasswordPlaceholder"
                placeholder="Skriv inn nytt passord"
                minlength="8"
                autocomplete="new-password"
              />
              <small class="form-hint" i18n="@@settings.passwordHint">
                Minimum 8 tegn, m√• inneholde stor bokstav, liten bokstav og tall
              </small>
            </div>

            <div class="form-group">
              <label for="confirmPassword" i18n="@@settings.confirmPasswordLabel"
                >Bekreft nytt passord</label
              >
              <input
                type="password"
                id="confirmPassword"
                name="confirmPassword"
                [(ngModel)]="confirmPassword"
                i18n-placeholder="@@settings.confirmPasswordPlaceholder"
                placeholder="Bekreft nytt passord"
                autocomplete="new-password"
              />
            </div>
          </div>
        }

        <!-- Save Button -->
        <div class="form-actions">
          <button type="submit" class="btn btn-primary" [disabled]="saving()">
            @if (saving()) {
              <span i18n="@@settings.saving">Lagrer...</span>
            } @else {
              <span i18n="@@settings.saveChanges">Lagre endringer</span>
            }
          </button>
        </div>
      </form>
    </section>

    <!-- Household Section -->
    @if (activeHousehold()) {
      <section class="settings-section">
        <h2 i18n="@@settings.householdTitle">Husstand</h2>

        <div class="household-info">
          <div class="info-row">
            <span class="info-label" i18n="@@settings.currentHouseholdLabel"
              >N√•v√¶rende husstand</span
            >
            <span class="info-value">{{ activeHousehold()?.name }}</span>
          </div>
        </div>

        <div class="household-links">
          <a routerLink="/household/settings" class="settings-link">
            <span class="link-icon">‚öôÔ∏è</span>
            <span class="link-text" i18n="@@settings.householdSettingsLink"
              >Husstandsinnstillinger</span
            >
            <span class="link-arrow">‚Üí</span>
          </a>

          <a routerLink="/households" class="settings-link">
            <span class="link-icon">üè†</span>
            <span class="link-text" i18n="@@settings.manageHouseholdsLink"
              >Administrer husstander</span
            >
            <span class="link-arrow">‚Üí</span>
          </a>

          <a routerLink="/invitations" class="settings-link">
            <span class="link-icon">‚úâÔ∏è</span>
            <span class="link-text" i18n="@@settings.invitationsLink">Invitasjoner</span>
            @if (pendingInvitationsCount() > 0) {
              <span class="badge">{{ pendingInvitationsCount() }}</span>
            }
            <span class="link-arrow">‚Üí</span>
          </a>
        </div>
      </section>
    }

    <!-- Account Section -->
    <section class="settings-section">
      <h2 i18n="@@settings.accountTitle">Konto</h2>

      <div class="account-info">
        <div class="info-row">
          <span class="info-label" i18n="@@settings.memberSinceLabel">Medlem siden</span>
          <span class="info-value">{{ profile()?.createdAt | date: 'mediumDate' }}</span>
        </div>
      </div>

      <div class="danger-zone">
        <button
          type="button"
          class="btn btn-danger"
          (click)="logout()"
          i18n="@@settings.logOutButton"
        >
          Logg ut
        </button>
      </div>
    </section>

    <!-- About Section -->
    <section class="settings-section">
      <h2 i18n="@@settings.aboutTitle">Om</h2>

      <div class="account-info">
        <div class="info-row">
          <span class="info-label" i18n="@@settings.versionLabel">Versjon</span>
          <span class="info-value">{{ appVersion }}</span>
        </div>
        <div class="info-row">
          <span class="info-label" i18n="@@settings.buildLabel">Bygg</span>
          <span class="info-value">{{ buildTime | date: 'medium' }}</span>
        </div>
      </div>
    </section>
  </app-page>
}
