<div class="child-dashboard">
  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p i18n="@@childDashboard.loading">Laster oppgavene dine...</p>
    </div>
  }

  <!-- Error State -->
  @if (!isLoading() && errorMessage()) {
    <div class="error-container">
      <div class="error-icon">‚ö†Ô∏è</div>
      <p class="error-message">{{ errorMessage() }}</p>
      <button class="retry-button" (click)="loadMyTasks()" i18n="@@childDashboard.tryAgain">
        Pr√∏v igjen
      </button>
    </div>
  }

  <!-- Main Content -->
  @if (!isLoading() && !errorMessage()) {
    <!-- Greeting -->
    <header class="greeting-section">
      <h1 class="greeting" i18n="@@childDashboard.greeting">Hei {{ childName() }}! üëã</h1>
    </header>

    <!-- Tasks List -->
    <section class="tasks-section">
      <h2 i18n="@@childDashboard.todaysTasks">Dagens oppgaver</h2>

      @if (!hasTasks()) {
        <!-- Empty State -->
        <div class="empty-state">
          <div class="empty-icon">üéâ</div>
          <p class="empty-message" i18n="@@childDashboard.noTasksToday">Ingen oppgaver i dag!</p>
          <p class="empty-subtitle" i18n="@@childDashboard.enjoyFreeTime">Nyt fritiden din!</p>
        </div>
      } @else {
        <!-- Pending Tasks -->
        @if (pendingTasks().length > 0) {
          <div class="task-group">
            <h3 class="task-group-title" i18n="@@childDashboard.toDo">√Ö gj√∏re</h3>
            @for (task of pendingTasks(); track task.id) {
              <div
                class="task-card pending"
                role="article"
                [attr.aria-label]="'Task: ' + task.taskName"
              >
                <div class="task-header">
                  <h4 class="task-name">{{ task.taskName }}</h4>
                  <span class="task-points" [attr.aria-label]="task.points + ' points'">
                    {{ task.points }} <ng-container i18n="@@childDashboard.pts">poeng</ng-container>
                  </span>
                </div>
                @if (task.taskDescription) {
                  <p class="task-description">{{ task.taskDescription }}</p>
                }
                <button
                  class="mark-done-button"
                  (click)="onMarkDone(task)"
                  [disabled]="isCompleting(task.id)"
                  [attr.aria-label]="'Mark ' + task.taskName + ' as done'"
                >
                  @if (isCompleting(task.id)) {
                    <span class="button-spinner"></span>
                    <span i18n="@@childDashboard.marking">Markerer...</span>
                  } @else {
                    <span i18n="@@childDashboard.markDone">‚úì Merk som ferdig</span>
                  }
                </button>
              </div>
            }
          </div>
        }

        <!-- Completed Tasks -->
        @if (completedTasks().length > 0) {
          <div class="task-group">
            <h3 class="task-group-title" i18n="@@childDashboard.completed">Fullf√∏rt</h3>
            @for (task of completedTasks(); track task.id) {
              <div
                class="task-card completed"
                role="article"
                [attr.aria-label]="'Completed task: ' + task.taskName"
              >
                <div class="task-header">
                  <h4 class="task-name">{{ task.taskName }}</h4>
                  <span class="task-points" [attr.aria-label]="task.points + ' points earned'">
                    {{ task.points }} <ng-container i18n="@@childDashboard.pts">poeng</ng-container>
                  </span>
                </div>
                @if (task.taskDescription) {
                  <p class="task-description">{{ task.taskDescription }}</p>
                }
                <div class="completed-badge">
                  <span class="checkmark">‚úì</span>
                  <span i18n="@@childDashboard.done">Ferdig!</span>
                </div>
              </div>
            }
          </div>
        }
      }
    </section>

    <!-- Available Single Tasks -->
    @if (hasAvailableTasks()) {
      <app-available-tasks-section />
    }

    <!-- Points Progress -->
    <section class="points-section">
      <div class="points-header">
        <h2 i18n="@@childDashboard.todaysPoints">Dagens poeng</h2>
        <div class="points-display">
          <span class="completed-points">{{ completedPoints() }}</span>
          <span class="points-separator">/</span>
          <span class="total-points">{{ totalPoints() }}</span>
        </div>
      </div>
      <div class="progress-bar-container">
        <div
          class="progress-bar"
          [class]="getProgressClass()"
          [style.width.%]="progressPercent()"
          role="progressbar"
          [attr.aria-valuenow]="progressPercent()"
          [attr.aria-valuemin]="0"
          [attr.aria-valuemax]="100"
        ></div>
      </div>
      @if (allCompleted() && hasTasks()) {
        <div class="celebration" i18n="@@childDashboard.allComplete">
          üéâ Alle oppgaver fullf√∏rt! Bra jobba!
        </div>
      }
    </section>

    <!-- Streak and Progress Section -->
    @if (analytics()) {
      <section class="analytics-section">
        <!-- Streak Counter -->
        <app-streak-counter
          [currentStreak]="analytics()!.currentStreak"
          [longestStreak]="analytics()!.longestStreak"
        />

        <!-- Week/Month Progress -->
        <div class="progress-cards">
          <app-progress-summary
            i18n-title="@@childDashboard.thisWeek"
            title="Denne uken"
            icon="üìÖ"
            [progress]="analytics()!.weekProgress"
          />
          <app-progress-summary
            i18n-title="@@childDashboard.thisMonth"
            title="Denne m√•neden"
            icon="üìÜ"
            [progress]="analytics()!.monthProgress"
          />
        </div>

        <!-- Daily Points Chart -->
        @if (analytics()!.dailyPoints.length > 0) {
          <app-daily-points-chart
            [dailyData]="analytics()!.dailyPoints"
            i18n-title="@@childDashboard.pointsThisWeek"
            title="Poeng denne uken"
          />
        }
      </section>
    }
  }
</div>
