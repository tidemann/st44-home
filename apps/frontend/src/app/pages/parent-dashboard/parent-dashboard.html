<main class="dashboard" role="main" aria-label="Parent Dashboard">
  <!-- Header -->
  <header class="dashboard-header">
    <div class="header-content">
      @if (household()) {
        <h1 class="household-name">{{ household()!.name }}</h1>
      } @else {
        <h1 class="household-name">Dashboard</h1>
      }
      <app-household-switcher (householdChanged)="onHouseholdChanged()" />
    </div>
    <nav class="header-actions" aria-label="Quick actions">
      <a routerLink="/household/settings" class="btn btn-icon" aria-label="Household settings">
        <span aria-hidden="true">âš™ï¸</span>
      </a>
    </nav>
  </header>

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-state" role="status" aria-live="polite">
      <div class="loading-spinner" aria-hidden="true"></div>
      <p>Loading dashboard...</p>
    </div>
  }

  <!-- Error State -->
  @if (errorMessage()) {
    <div class="alert alert-error" role="alert">
      <p>{{ errorMessage() }}</p>
      <button type="button" class="btn btn-secondary" (click)="loadDashboard()">Try Again</button>
    </div>
  }

  <!-- Dashboard Content -->
  @if (!isLoading() && !errorMessage()) {
    <!-- Week Summary Card -->
    <section class="summary-card" aria-labelledby="week-summary-title">
      <h2 id="week-summary-title" class="section-title">
        <span aria-hidden="true">ğŸ“Š</span> This Week
      </h2>

      @if (hasTasks()) {
        <div class="summary-stats">
          <div class="stat-main">
            <span class="stat-value">{{ weekSummary().total }}</span>
            <span class="stat-label">Tasks</span>
          </div>
          <div class="stat-completion" [class]="getCompletionClass(weekSummary().completionRate)">
            <span class="stat-value">{{ weekSummary().completionRate }}%</span>
            <span class="stat-label">Complete</span>
          </div>
        </div>

        <div class="stat-breakdown">
          <span class="stat-item stat-completed" title="Completed tasks">
            <span aria-hidden="true">âœ…</span> {{ weekSummary().completed }}
          </span>
          <span class="stat-item stat-pending" title="Pending tasks">
            <span aria-hidden="true">â³</span> {{ weekSummary().pending }}
          </span>
          @if (weekSummary().overdue > 0) {
            <span class="stat-item stat-overdue" title="Overdue tasks">
              <span aria-hidden="true">âš ï¸</span> {{ weekSummary().overdue }}
            </span>
          }
        </div>
      } @else {
        <div class="empty-state">
          <p>No tasks this week. Create your first task!</p>
          <a [routerLink]="['/households', household()!.id, 'tasks']" class="btn btn-primary">
            <span aria-hidden="true">+</span> Create Task
          </a>
        </div>
      }
    </section>

    <!-- Children Section -->
    <section class="children-section" aria-labelledby="children-title">
      <h2 id="children-title" class="section-title"><span aria-hidden="true">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span> Children</h2>

      @if (hasChildren()) {
        <ul class="children-list" role="list">
          @for (child of children(); track child.id) {
            <li class="child-item">
              <div class="child-info">
                <div class="child-name-row">
                  <span class="child-name">{{ child.name }}</span>
                  @if (hasAccount(child.id)) {
                    <span class="account-badge has-account" title="Has login account">
                      <span aria-hidden="true">âœ“</span> Account
                    </span>
                  } @else {
                    <span class="account-badge no-account" title="No login account">
                      <span aria-hidden="true">âš </span> No Account
                    </span>
                  }
                </div>
                @if (child.tasksTotal > 0) {
                  <span class="child-stats">
                    {{ child.tasksCompleted }}/{{ child.tasksTotal }} tasks
                  </span>
                } @else {
                  <span class="child-stats empty-state-text"> No tasks assigned yet </span>
                }
              </div>
              <div class="child-actions">
                @if (child.tasksTotal > 0) {
                  <div class="progress-container">
                    <div
                      class="progress-bar"
                      [class]="getCompletionClass(child.completionRate)"
                      [style.width.%]="child.completionRate"
                      role="progressbar"
                      [attr.aria-valuenow]="child.completionRate"
                      aria-valuemin="0"
                      aria-valuemax="100"
                      [attr.aria-label]="child.name + ' completion: ' + child.completionRate + '%'"
                    ></div>
                  </div>
                  <span class="completion-rate" [class]="getCompletionClass(child.completionRate)">
                    {{ child.completionRate }}%
                  </span>
                }
                @if (!hasAccount(child.id)) {
                  <button
                    type="button"
                    class="btn btn-sm btn-primary"
                    (click)="showCreateAccountModal(child.id)"
                  >
                    <span aria-hidden="true">+</span> Create Account
                  </button>
                } @else if (child.tasksTotal === 0) {
                  <a
                    [routerLink]="['/households', household()!.id, 'tasks']"
                    class="btn btn-sm btn-secondary"
                  >
                    Assign Task
                  </a>
                }
              </div>
            </li>
          }
        </ul>
      } @else {
        <div class="empty-state">
          <p>Add your children to start assigning tasks.</p>
          <a routerLink="/household/settings" class="btn btn-primary">
            <span aria-hidden="true">+</span> Add Child
          </a>
        </div>
      }
    </section>

    <!-- Generation Message -->
    @if (generationMessage()) {
      <div
        class="alert"
        [class.alert-success]="generationMessage().includes('Generated')"
        [class.alert-info]="generationMessage().includes('No new')"
        [class.alert-error]="
          generationMessage().includes('Failed') || generationMessage().includes('permission')
        "
        role="status"
        aria-live="polite"
      >
        {{ generationMessage() }}
      </div>
    }

    <!-- Quick Actions -->
    <footer class="quick-actions">
      <button
        type="button"
        class="btn btn-primary"
        (click)="openManualAssignmentModal()"
        [disabled]="!hasChildren() || tasksList().length === 0"
        [title]="
          !hasChildren()
            ? 'Add children first'
            : tasksList().length === 0
              ? 'Create tasks first'
              : 'Manually assign a task'
        "
      >
        <span aria-hidden="true">âœ…</span> Assign Task
      </button>
      <button
        type="button"
        class="btn btn-secondary"
        (click)="generateTodaysTasks()"
        [disabled]="isGenerating()"
      >
        @if (isGenerating()) {
          <span aria-hidden="true">â³</span> Generating...
        } @else {
          <span aria-hidden="true">ğŸ”„</span> Generate Today's Tasks
        }
      </button>
      <a [routerLink]="['/households', household()!.id, 'tasks']" class="btn btn-secondary">
        <span aria-hidden="true">+</span> Add Task
      </a>
      <a routerLink="/household/settings" class="btn btn-secondary">
        <span aria-hidden="true">ğŸ“‹</span> Manage Household
      </a>
    </footer>
  }

  <!-- Create Account Modal -->
  @if (selectedChildForAccount()) {
    <div
      class="modal-overlay"
      role="button"
      tabindex="0"
      (click)="onCreateAccountCancelled()"
      (keydown.enter)="onCreateAccountCancelled()"
      (keydown.escape)="onCreateAccountCancelled()"
    >
      <div
        class="modal-content"
        role="dialog"
        tabindex="-1"
        (click)="$event.stopPropagation()"
        (keydown)="$event.stopPropagation()"
      >
        <app-create-child-account
          [child]="selectedChildForAccount()!"
          [householdId]="household()!.id"
          (accountCreated)="onAccountCreated()"
          (cancelled)="onCreateAccountCancelled()"
        />
      </div>
    </div>
  }

  <!-- Manual Assignment Modal -->
  @if (showManualAssignmentModal()) {
    <app-manual-assignment-modal
      [tasks]="tasksList()"
      [children]="childrenList()"
      [householdId]="household()!.id"
      (closeModal)="closeManualAssignmentModal()"
      (assignmentCreated)="onManualAssignmentCreated()"
    />
  }
</main>
